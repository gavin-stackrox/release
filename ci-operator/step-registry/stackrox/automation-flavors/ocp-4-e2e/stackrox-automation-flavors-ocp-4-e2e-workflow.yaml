workflow:
  as: stackrox-automation-flavors-ocp-4-e2e
  steps:
    pre:
    - as: ocp-4-create
      commands: |
        echo "Testing environment"
        echo "df /tmp"
        df --si /tmp || true
        echo "mod /tmp"
        echo modified > /tmp/ttt || true
        ls -l /tmp/ttt || true
        echo "get the installer"
        curl -D - --location -o /tmp/ttt2 "https://mirror.openshift.com/pub/openshift-v4/clients/${OCP_VERSION}/openshift-install-linux.tar.gz" || true
        ls -l /tmp/ttt2 || true
        rm -f /tmp/ttt2
        sed -e 's#curl#curl --location#' < /usr/bin/openshift-ci.sh > /tmp/openshift-ci.sh
        diff -wu /usr/bin/openshift-ci.sh /tmp/openshift-ci.sh || true
        chmod 0755 /tmp/openshift-ci.sh
        echo "Running openshift-4 ${OCP_VERSION} automation"
        /tmp/openshift-ci.sh create openshift-4 "${OCP_VERSION}"
      credentials:
      - mount_path: /tmp/vault/stackrox-automation-flavors
        name: stackrox-automation-flavors
        namespace: test-credentials
      env:
      - name: OCP_VERSION
        default: 'ocp/stable-4.13'
      from: ocp-4
      resources:
        requests:
          cpu: 2000m
          memory: 4000Mi
    test:
    - ref: stackrox-e2e
    post:
    - as: ocp-4-destroy
      commands: |
        /usr/bin/openshift-ci.sh destroy openshift-4
      credentials:
      - mount_path: /tmp/vault/stackrox-automation-flavors
        name: stackrox-automation-flavors
        namespace: test-credentials
      from: ocp-4
      resources:
        requests:
          cpu: 2000m
          memory: 4000Mi
  documentation: |-
    A stackrox workflow to execute e2e QA tests in an OSD GCP cluster.
